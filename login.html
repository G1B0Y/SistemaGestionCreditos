<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión</title>
    <link rel="stylesheet" href="loginstyles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="icon" href="images/icono.png" type="image/png">
    <style>
        .error-message {
            color: red;
            font-size: 13px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="content">
        <div class="text">Login Form</div>
        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="field">
                <span class="fa fa-id-card"></span>
                <input type="text" id="dni" placeholder="DNI" required>
                <div id="dni-error" class="error-message"></div>
            </div>

            <div class="field">
                <span class="fas fa-lock"></span>
                <input type="password" id="password" placeholder="Contraseña" required>
                <span class="toggle-password" onclick="togglePasswordVisibility()">
                    <i class="fas fa-eye"></i>
                </span>
            </div>

            <div class="forgot-pass"><a href="#">¿Olvidaste tu contraseña?</a></div>

            <button type="submit">Iniciar Sesión</button>

            <div class="singup-link">¿No estás registrado? 
                <a href="register.html">Regístrate</a>
            </div>
        </form>
    </div>

    <script>
        // Mostrar/Ocultar contraseña
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.querySelector('.toggle-password i');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        // Validar DNI (exactamente 8 dígitos)
        function validateDNI() {
            const dniInput = document.getElementById('dni');
            const dniError = document.getElementById('dni-error');
            const dniValue = dniInput.value.trim();

            if (dniValue.length !== 8 || isNaN(dniValue)) {
                dniError.textContent = 'El DNI debe tener exactamente 8 dígitos numéricos.';
                return false;
            } else {
                dniError.textContent = '';
                return true;
            }
        }

        // Manejar el evento del formulario
        async function handleLogin(event) {
            event.preventDefault(); // Evitar que se envíe el formulario automáticamente

            // Validar DNI
            const isDNIValid = validateDNI();

            if (!isDNIValid) {
                return; // Detener el proceso si el DNI no es válido
            }

            // Obtener los valores ingresados
            const dni = document.getElementById('dni').value.trim();
            const password = document.getElementById('password').value.trim();

            // Construir el objeto para enviar al backend
            const loginData = {
                numeroDocumento: dni,
                contraseña: password
            };

            try {
                const response = await fetch('http://localhost:8080/Inicio/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginData),
                });

                if (response.ok) {
                    const data = await response.json();
                    // Almacenar el idUsuario en sessionStorage
                    sessionStorage.setItem('idUsuario', data.idUsuario);

                    // Redirigir según el tipo de usuario
                    if (data.tipo === 'Cliente') {
                        window.location.href = 'user/userhome.html'; // Ruta corregida para clientes
                    } else if (data.tipo === 'Administrador') {
                        window.location.href = 'admin/adminhome.html'; // Ruta corregida para administradores
                    }
                } else {
                    const error = await response.text();
                    console.error('Error en el backend:', error);  // Imprime el mensaje de error
                    alert('Credenciales incorrectas. Por favor, verifica tu DNI y contraseña.');
                }
            } catch (error) {
                console.error('Error al intentar iniciar sesión:', error);
                alert('Hubo un error al procesar la solicitud. Intenta de nuevo más tarde.');
            }
        }

        // Validar DNI en tiempo real
        const dniInput = document.getElementById('dni');
        dniInput.addEventListener('input', validateDNI);
    </script>
</body>
</html>
